"""
–û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å AI-–∞–≥–µ–Ω—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –∫—Ä–µ–¥–∏—Ç–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏.
"""

import logging
from typing import Optional, List, Dict, Any
from pathlib import Path

from langchain_community.agent_toolkits.sql.base import create_sql_agent
from langchain_community.agent_toolkits.sql.toolkit import SQLDatabaseToolkit
from langchain_community.utilities import SQLDatabase
from langchain.agents import AgentType
from langchain_openai import ChatOpenAI
from langchain_anthropic import ChatAnthropic
from sqlalchemy import create_engine, text

from config import AgentConfig
from logging_utils import log_agent_interaction, log_sql_event


class CreditSimulationAgent:
    """
    AI-–∞–≥–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç LangChain SQL Agent –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –∫—Ä–µ–¥–∏—Ç–Ω–æ–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ.
    
    Attributes:
        config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞
        logger: –õ–æ–≥–≥–µ—Ä
        db: SQLDatabase –æ–±—ä–µ–∫—Ç LangChain
        llm: –Ø–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å (OpenAI –∏–ª–∏ Anthropic)
        agent: SQL-–∞–≥–µ–Ω—Ç LangChain
    """
    
    # –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î –∏ –±–∏–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    DB_CONTEXT = """
    # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö NCL Credit Simulation
    
    ## –¢–∞–±–ª–∏—Ü—ã:
    
    ### 1. loan_issue - –í—ã–¥–∞—á–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤ (–ú–æ–¥—É–ª—å 1)
    –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤—ã–¥–∞–Ω–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–∞—Ö.
    
    –ü–æ–ª—è:
    - loan_id: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫—Ä–µ–¥–∏—Ç–∞ (PRIMARY KEY)
    - issue_date: –î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ (—Ñ–æ—Ä–º–∞—Ç: YYYY-MM-DD)
    - cohort_month: –ú–µ—Å—è—Ü –∫–æ–≥–æ—Ä—Ç—ã –¥–ª—è vintage-–∞–Ω–∞–ª–∏–∑–∞ (YYYY-MM-01)
    - loan_amount: –°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ –≤ —Ä—É–±–ª—è—Ö
    - interest_rate: –ì–æ–¥–æ–≤–∞—è –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (%)
    - term_months: –°—Ä–æ–∫ –∫—Ä–µ–¥–∏—Ç–∞ –≤ –º–µ—Å—è—Ü–∞—Ö
    - product_type: –¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞ (consumer_loan, auto_loan, mortgage –∏ —Ç.–¥.)
    
    –ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞ –º–æ–º–µ–Ω—Ç –≤—ã–¥–∞—á–∏:
    - macro_rate_cbr: –ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§ (%)
    - macro_employment_rate: –£—Ä–æ–≤–µ–Ω—å –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ (%)
    - macro_unemployment_rate: –£—Ä–æ–≤–µ–Ω—å –±–µ–∑—Ä–∞–±–æ—Ç–∏—Ü—ã (%)
    - macro_index: –ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å
    
    –°–µ–∑–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
    - season_k_issue: –°–µ–∑–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –≤—ã–¥–∞—á
    - season_k_amount: –°–µ–∑–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è —Å—É–º–º—ã –≤—ã–¥–∞—á
    - season_period_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∑–æ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
    
    –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è:
    - created_at: Timestamp —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
    - batch_id: ID –±–∞—Ç—á–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
    
    ### 2. credit_fact_history - –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–∫—Ç (–ú–æ–¥—É–ª—å 2)
    –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º.
    
    –ü–æ–ª—è:
    - loan_id: ID –∫—Ä–µ–¥–∏—Ç–∞ (FK -> loan_issue)
    - period_month: –û—Ç—á–µ—Ç–Ω—ã–π –º–µ—Å—è—Ü (YYYY-MM-01)
    - MOB: Months On Book - –º–µ—Å—è—Ü–µ–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ —Å –º–æ–º–µ–Ω—Ç–∞ –≤—ã–¥–∞—á–∏
    
    –ë–∞–ª–∞–Ω—Å—ã:
    - balance_principal: –û—Å—Ç–∞—Ç–æ–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–ª–≥–∞
    - overdue_principal: –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–ª–≥
    - interest_scheduled: –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
    - overdue_interest: –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
    
    –ü–ª–∞—Ç–µ–∂–∏:
    - scheduled_payment: –ü–ª–∞–Ω–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ (–∞–Ω–Ω—É–∏—Ç–µ—Ç)
    - actual_payment: –§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ–ø–ª–∞—á–µ–Ω–Ω–∞—è —Å—É–º–º–∞
    
    –ü—Ä–æ—Å—Ä–æ—á–∫–∞ (DPD - Days Past Due):
    - DPD_bucket: –ö–æ—Ä–∑–∏–Ω–∞ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ ('0', '1-30', '31-60', '61-90', '90+')
    - overdue_days: –¢–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏
    
    –°—Ç–∞—Ç—É—Å—ã:
    - status: –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (Active, Closed, Default)
    - migration_scenario: –°—Ü–µ–Ω–∞—Ä–∏–π –º–∏–≥—Ä–∞—Ü–∏–∏ –º–µ–∂–¥—É –±–∞–∫–µ—Ç–∞–º–∏ (cure/default)
    
    –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ:
    - created_at: Timestamp
    - batch_id: ID –±–∞—Ç—á–∞
    
    ### 3. macro_params_log - –õ–æ–≥ –º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    –ò—Å—Ç–æ—Ä–∏—è –º–∞–∫—Ä–æ–ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ø–æ –º–µ—Å—è—Ü–∞–º.
    
    –ü–æ–ª—è:
    - year_month: –ú–µ—Å—è—Ü (YYYY-MM-01)
    - rate_cbr: –ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§
    - employment_rate: –£—Ä–æ–≤–µ–Ω—å –∑–∞–Ω—è—Ç–æ—Å—Ç–∏
    - unemployment_rate: –£—Ä–æ–≤–µ–Ω—å –±–µ–∑—Ä–∞–±–æ—Ç–∏—Ü—ã
    - macro_index: –ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å
    - k_macro_calculated: –†–∞—Å—á–µ—Ç–Ω—ã–π –º–∞–∫—Ä–æ-–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
    - source: –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
    
    ## –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏ –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:
    
    ### DPD Buckets (–ö–æ—Ä–∑–∏–Ω—ã –ø—Ä–æ—Å—Ä–æ—á–∫–∏):
    - '0': –ù–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–∫–∏ (current)
    - '1-30': –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ—Å—Ä–æ—á–∫–∞ (1-30 –¥–Ω–µ–π)
    - '31-60': –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ—Å—Ä–æ—á–∫–∞ (31-60 –¥–Ω–µ–π)
    - '61-90': –°–µ—Ä—å–µ–∑–Ω–∞—è –ø—Ä–æ—Å—Ä–æ—á–∫–∞ (61-90 –¥–Ω–µ–π)
    - '90+': –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ—Å—Ä–æ—á–∫–∞ (–±–æ–ª–µ–µ 90 –¥–Ω–µ–π)
    
    ### PAR (Portfolio At Risk) - –ü–æ—Ä—Ç—Ñ–µ–ª—å –ø–æ–¥ —Ä–∏—Å–∫–æ–º:
    - PAR30: –î–æ–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª—è (–ø–æ –±–∞–ª–∞–Ω—Å—É) —Å DPD >= 30 –¥–Ω–µ–π
    - PAR60: –î–æ–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª—è —Å DPD >= 60 –¥–Ω–µ–π
    - PAR90: –î–æ–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª—è —Å DPD >= 90 –¥–Ω–µ–π
    
    –§–æ—Ä–º—É–ª–∞ PAR30:
    ```sql
    SUM(CASE WHEN DPD_bucket IN ('31-60', '61-90', '90+') THEN balance_principal ELSE 0 END) / 
    SUM(balance_principal)
    ```
    
    ### IFRS9 Stage Mix (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–∫—Å–∏-–º–æ–¥–µ–ª—å):
    - Stage 1: Performing (DPD = '0')
    - Stage 2: Underperforming (DPD IN ('1-30', '31-60'))
    - Stage 3: Non-performing (DPD IN ('61-90', '90+'))
    
    ### Cure Rate (–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ–∑–¥–æ—Ä–æ–≤–ª–µ–Ω–∏—è):
    –ü—Ä–æ—Ü–µ–Ω—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —É–ª—É—á—à–∏–ª–∏ —Å–≤–æ–π DPD bucket (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å '1-30' –Ω–∞ '0')
    
    ### Default Rate (–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–µ—Ñ–æ–ª—Ç–∞):
    –ü—Ä–æ—Ü–µ–Ω—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ—à–ª–∏ –≤ —Å—Ç–∞—Ç—É—Å 'Default'
    
    ### Roll Rate (–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–µ—Ä–µ—Ç–æ–∫–∞):
    –ü—Ä–æ—Ü–µ–Ω—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –∏–∑ –æ–¥–Ω–æ–≥–æ DPD bucket –≤ —Å–ª–µ–¥—É—é—â–∏–π (—Ö—É–∂–µ)
    
    ### Vintage Analysis (–ö–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑):
    –ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤, –≤—ã–¥–∞–Ω–Ω—ã—Ö –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –º–µ—Å—è—Ü (cohort_month)
    –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å—Ä–∞–≤–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞–∑–Ω—ã—Ö –∫–æ–≥–æ—Ä—Ç.
    
    ### MOB (Months On Book):
    –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤ —Å –º–æ–º–µ–Ω—Ç–∞ –≤—ã–¥–∞—á–∏ –∫—Ä–µ–¥–∏—Ç–∞.
    MOB = 0 - –º–µ—Å—è—Ü –≤—ã–¥–∞—á–∏
    MOB = 1 - –ø–µ—Ä–≤—ã–π –º–µ—Å—è—Ü –ø–æ—Å–ª–µ –≤—ã–¥–∞—á–∏
    –∏ —Ç.–¥.
    
    ## –ü–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö:
    2010-01-01 –¥–æ 2015-12-31 (–≤–∫–ª—é—á–∞—è –∫—Ä–∏–∑–∏—Å 2014-2015)
    
    ## –í–∞–∂–Ω—ã–µ SQL-–ø–∞—Ç—Ç–µ—Ä–Ω—ã:
    
    ### –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º:
    ```sql
    -- –í–∞—Ä–∏–∞–Ω—Ç 1: substr
    SELECT substr(issue_date, 1, 7) as month, COUNT(*) 
    FROM loan_issue 
    GROUP BY month;
    
    -- –í–∞—Ä–∏–∞–Ω—Ç 2: strftime
    SELECT strftime('%Y-%m', issue_date) as month, COUNT(*) 
    FROM loan_issue 
    GROUP BY month;
    ```
    
    ### JOIN —Ç–∞–±–ª–∏—Ü:
    ```sql
    SELECT 
        li.loan_id,
        li.issue_date,
        cfh.period_month,
        cfh.DPD_bucket
    FROM loan_issue li
    JOIN credit_fact_history cfh ON li.loan_id = cfh.loan_id
    WHERE li.issue_date >= '2010-01-01';
    ```
    
    ### –†–∞—Å—á–µ—Ç PAR30:
    ```sql
    SELECT 
        period_month,
        ROUND(100.0 * 
            SUM(CASE WHEN DPD_bucket IN ('31-60', '61-90', '90+') 
                THEN balance_principal ELSE 0 END) / 
            NULLIF(SUM(balance_principal), 0), 2
        ) as PAR30_pct
    FROM credit_fact_history
    WHERE status = 'Active'
    GROUP BY period_month
    ORDER BY period_month;
    ```
    
    ## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º:
    1. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
    2. –ò—Å–ø–æ–ª—å–∑—É–π ROUND(..., 2) –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –∏ –¥–µ–Ω–µ–∂–Ω—ã—Ö —Å—É–º–º
    3. –î–ª—è –¥–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç ISO: YYYY-MM-DD
    4. –ü–æ–º–Ω–∏ –ø—Ä–æ NULL –∑–Ω–∞—á–µ–Ω–∏—è - –∏—Å–ø–æ–ª—å–∑—É–π NULLIF –∏ COALESCE
    5. –î–ª—è —Ç–æ–ø-N –∏—Å–ø–æ–ª—å–∑—É–π ORDER BY + LIMIT
    6. –§–∏–ª—å—Ç—Ä—É–π —Ç–æ–ª—å–∫–æ Active –∫—Ä–µ–¥–∏—Ç—ã –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
    """
    
    def __init__(self, config: AgentConfig):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞.
        
        Args:
            config: –û–±—ä–µ–∫—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ AgentConfig
        """
        self.config = config
        self.logger = config.setup_logging()
        
        self.logger.info(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AI-–∞–≥–µ–Ω—Ç–∞ (provider={config.llm_provider})")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ë–î
        if not Path(config.db_path).exists():
            raise FileNotFoundError(f"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {config.db_path}")
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
        db_uri = f"sqlite:///{config.db_path}"
        self.engine = create_engine(db_uri, echo=config.verbose)
        self.db = SQLDatabase(self.engine)
        
        self.logger.info(f"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î: {config.db_path}")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM
        self._init_llm()
        
        # –°–æ–∑–¥–∞–Ω–∏–µ SQL-–∞–≥–µ–Ω—Ç–∞
        self._create_agent()
        
        self.logger.info("AI-–∞–≥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def _init_llm(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —è–∑—ã–∫–æ–≤—É—é –º–æ–¥–µ–ª—å."""
        if self.config.llm_provider == "openai":
            self.logger.info(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI (model={self.config.openai_model})")
            self.llm = ChatOpenAI(
                model=self.config.openai_model,
                temperature=self.config.openai_temperature,
                max_tokens=self.config.openai_max_tokens,
                api_key=self.config.get_api_key()
            )
        elif self.config.llm_provider == "anthropic":
            self.logger.info(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Anthropic (model={self.config.anthropic_model})")
            self.llm = ChatAnthropic(
                model=self.config.anthropic_model,
                temperature=self.config.openai_temperature,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É
                api_key=self.config.get_api_key()
            )
        else:
            raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä: {self.config.llm_provider}")
    
    def _create_agent(self):
        """–°–æ–∑–¥–∞—Ç—å SQL-–∞–≥–µ–Ω—Ç–∞."""
        # –°–æ–∑–¥–∞–Ω–∏–µ toolkit
        self.toolkit = SQLDatabaseToolkit(db=self.db, llm=self.llm)
        
        # –ü—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
        prefix = f"""
        –¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è –±–∞–Ω–∫–∞ NCL.
        –£ —Ç–µ–±—è –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫—Ä–µ–¥–∏—Ç–∞—Ö, –≤—ã–¥–∞–Ω–Ω—ã—Ö —Å 2010 –ø–æ 2015 –≥–æ–¥.
        
        {self.DB_CONTEXT}
        
        –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
        1. –ü–æ–Ω—è—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –∫—Ä–µ–¥–∏—Ç–Ω–æ–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ
        2. –°–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π SQL-–∑–∞–ø—Ä–æ—Å –∫ SQLite –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        3. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        4. –î–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –±–∏–∑–Ω–µ—Å-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–µ–π
        
        –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:
        - –í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è–π —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º (–∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç sql_db_schema)
        - –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ (–æ–Ω–∏ —É–∫–∞–∑–∞–Ω—ã –≤—ã—à–µ)
        - –î–ª—è –¥–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD
        - –û–∫—Ä—É–≥–ª—è–π —á–∏—Å–ª–∞ –¥–æ 2 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
        - –î–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ —É–º–Ω–æ–∂–∞–π –Ω–∞ 100
        - –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
        - –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ - —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã
        - –ü—Ä–æ–≤–µ—Ä—è–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ –ø—É—Å—Ç–æ—Ç—É –∏ NULL
        
        –ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤:
        - "–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö 50,432 –∫—Ä–µ–¥–∏—Ç–∞. –ü–µ—Ä–∏–æ–¥: 2010-01-01 –¥–æ 2015-12-31."
        - "PAR30 –Ω–∞ –¥–µ–∫–∞–±—Ä—å 2015 —Å–æ—Å—Ç–∞–≤–∏–ª 8.3%, —á—Ç–æ –Ω–∞ 2.1% –≤—ã—à–µ, —á–µ–º –≥–æ–¥ –Ω–∞–∑–∞–¥."
        - "–¢–æ–ø-3 –º–µ—Å—è—Ü–∞ –ø–æ –≤—ã–¥–∞—á–∞–º: –º–∞–π 2013 (2.5 –º–ª—Ä–¥ —Ä—É–±), –∏—é–Ω—å 2013 (2.4 –º–ª—Ä–¥), –∞–ø—Ä–µ–ª—å 2013 (2.3 –º–ª—Ä–¥)"
        
        –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç - —Å–æ–æ–±—â–∏ –æ–± —ç—Ç–æ–º —è–≤–Ω–æ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É.
        """
        
        suffix = """
        –ù–∞—á–∏–Ω–∞–µ–º! –ü–æ–º–Ω–∏ –ø–æ—Ä—è–¥–æ–∫: 
        1. –ü—Ä–æ–≤–µ—Ä—å —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü
        2. –°–æ—Å—Ç–∞–≤—å SQL
        3. –í—ã–ø–æ–ª–Ω–∏ –∑–∞–ø—Ä–æ—Å
        4. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        5. –î–∞–π –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
        
        –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {input}
        
        –•–æ–¥ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π: {agent_scratchpad}
        """
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
        self.agent = create_sql_agent(
            llm=self.llm,
            toolkit=self.toolkit,
            agent_type=AgentType.ZERO_SHOT_REACT_DESCRIPTION,
            verbose=self.config.verbose,
            prefix=prefix,
            suffix=suffix,
            max_iterations=15,
            max_execution_time=120,
            early_stopping_method="generate",
            handle_parsing_errors=True
        )
    
    def query(self, question: str) -> Dict[str, Any]:
        """
        –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∞–≥–µ–Ω—Ç—É.
        
        Args:
            question: –í–æ–ø—Ä–æ—Å –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏:
            - success: bool - —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            - question: str - –∏—Å—Ö–æ–¥–Ω—ã–π –≤–æ–ø—Ä–æ—Å
            - answer: str - –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞
            - error: Optional[str] - —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –±—ã–ª–∞
        """
        self.logger.info(f"–ü–æ–ª—É—á–µ–Ω –≤–æ–ø—Ä–æ—Å: {question}")
        import time
        t0 = time.perf_counter()
        try:
            response = self.agent.invoke({"input": question})
            answer = response.get("output", "")
            dt = (time.perf_counter() - t0) * 1000.0
            self.logger.info(f"–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ (–¥–ª–∏–Ω–∞: {len(answer)} —Å–∏–º–≤–æ–ª–æ–≤, {dt:.0f} ms)")
            # JSONL –ª–æ–≥
            log_agent_interaction(
                self.config.history_file,
                question=question,
                success=True,
                answer=answer,
                latency_ms=dt,
            )
            return {
                "success": True,
                "question": question,
                "answer": answer,
                "error": None
            }
        except Exception as e:
            dt = (time.perf_counter() - t0) * 1000.0
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–æ–ø—Ä–æ—Å–∞: {e}", exc_info=True)
            log_agent_interaction(
                self.config.history_file,
                question=question,
                success=False,
                error=str(e),
                latency_ms=dt,
            )
            return {
                "success": False,
                "question": question,
                "answer": None,
                "error": str(e)
            }
    
    def get_table_info(self, table_name: Optional[str] = None) -> str:
        """
        –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞–±–ª–∏—Ü–∞—Ö –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
        
        Args:
            table_name: –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã (–µ—Å–ª–∏ None - –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã)
            
        Returns:
            –°—Ç—Ä–æ–∫–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü
        """
        if table_name:
            return self.db.get_table_info_no_throw([table_name])
        return self.db.get_table_info()
    
    def run_raw_sql(self, sql: str) -> Any:
        """
        –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—ã—Ä–æ–π SQL-–∑–∞–ø—Ä–æ—Å (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –ø—Ä—è–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤).
        
        Args:
            sql: SQL-–∑–∞–ø—Ä–æ—Å
            
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
        """
        self.logger.debug(f"–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ raw SQL: {sql}")
        import time
        t0 = time.perf_counter()
        try:
            result = self.db.run(sql)
            rows = len(result) if result else 0
            dt = (time.perf_counter() - t0) * 1000.0
            self.logger.debug(f"SQL –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ, —Å—Ç—Ä–æ–∫: {rows}, {dt:.0f} ms")
            log_sql_event(
                self.config.history_file,
                name="raw_sql",
                sql=sql,
                success=True,
                rowcount=rows,
                duration_ms=dt,
            )
            return result
        except Exception as e:
            dt = (time.perf_counter() - t0) * 1000.0
            self.logger.error(f"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL: {e}")
            log_sql_event(
                self.config.history_file,
                name="raw_sql",
                sql=sql,
                success=False,
                rowcount=0,
                duration_ms=dt,
                error=str(e),
            )
            raise
    
    def get_example_questions(self) -> List[str]:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∞–≥–µ–Ω—Ç–∞.
        
        Returns:
            –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
        """
        return [
            # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            "–°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö?",
            "–ö–∞–∫–æ–π –ø–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ?",
            "–ö–∞–∫–æ–π –æ–±—â–∏–π –æ–±—ä–µ–º –≤—ã–¥–∞—á –≤ —Ä—É–±–ª—è—Ö?",
            "–ö–∞–∫–æ–π —Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –∫—Ä–µ–¥–∏—Ç–∞?",
            "–ö–∞–∫–∞—è —Å—Ä–µ–¥–Ω—è—è –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞?",
            
            # –ê–Ω–∞–ª–∏–∑ –≤—ã–¥–∞—á
            "–ü–æ–∫–∞–∂–∏ —Ç–æ–ø-5 –º–µ—Å—è—Ü–µ–≤ –ø–æ –æ–±—ä–µ–º—É –≤—ã–¥–∞—á",
            "–ö–∞–∫ –º–µ–Ω—è–ª—Å—è –æ–±—ä–µ–º –≤—ã–¥–∞—á –ø–æ –≥–æ–¥–∞–º?",
            "–ö–∞–∫–∞—è —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –≤ –≤—ã–¥–∞—á–∞—Ö –ø–æ –º–µ—Å—è—Ü–∞–º –≥–æ–¥–∞?",
            "–ö–∞–∫–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ —á–µ–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º?",
            "–ö–∞–∫–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ –ø–æ –º–µ—Å—è—Ü–∞–º?",
            
            # –†–∏—Å–∫-–º–µ—Ç—Ä–∏–∫–∏
            "–ö–∞–∫–∞—è –¥–æ–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Å—Ä–æ—á–∫–µ 30+ –¥–Ω–µ–π?",
            "–ü–æ–∫–∞–∂–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø–æ DPD –±–∞–∫–µ—Ç–∞–º",
            "–ö–∞–∫–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ PAR30 –ø–æ –º–µ—Å—è—Ü–∞–º?",
            "–ö–∞–∫–æ–π PAR60 –∏ PAR90 –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É?",
            "–°–∫–æ–ª—å–∫–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤ –¥–µ—Ñ–æ–ª—Ç–µ?",
            
            # IFRS9
            "–ü–æ–∫–∞–∂–∏ IFRS9 stage mix –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É",
            "–ö–∞–∫ –º–µ–Ω—è–ª—Å—è stage mix –ø–æ –º–µ—Å—è—Ü–∞–º –≤ 2014-2015?",
            
            # –ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–∞
            "–ö–∞–∫ –º–µ–Ω—è–ª–∞—Å—å —Å—Ç–∞–≤–∫–∞ –¶–ë –ø–æ –≥–æ–¥–∞–º?",
            "–ö–∞–∫–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –º–µ–∂–¥—É —Å—Ç–∞–≤–∫–æ–π –¶–ë –∏ –æ–±—ä–µ–º–æ–º –≤—ã–¥–∞—á?",
            "–ö–∞–∫ –≤–ª–∏—è–ª–∞ –±–µ–∑—Ä–∞–±–æ—Ç–∏—Ü–∞ –Ω–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É?",
            "–ü–æ–∫–∞–∂–∏ –º–∞–∫—Ä–æ–ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ –ø–µ—Ä–∏–æ–¥ –∫—Ä–∏–∑–∏—Å–∞ 2014-2015",
            
            # –ü–ª–∞—Ç–µ–∂–∏
            "–ö–∞–∫–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∏ –ø–ª–∞–Ω–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π?",
            "–°–∫–æ–ª—å–∫–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –±—ã–ª–æ –∑–∞–∫—Ä—ã—Ç–æ –¥–æ—Å—Ä–æ—á–Ω–æ?",
            "–ö–∞–∫–æ–π —Å—Ä–µ–¥–Ω–∏–π —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–ª–∞—Ç–µ–∂ –ø–æ –º–µ—Å—è—Ü–∞–º?",
            
            # Vintage analysis
            "–ü–æ–∫–∞–∂–∏ vintage analysis –¥–ª—è –∫–æ–≥–æ—Ä—Ç 2010 –≥–æ–¥–∞",
            "–ö–∞–∫–∏–µ –∫–æ–≥–æ—Ä—Ç—ã –ø–æ–∫–∞–∑–∞–ª–∏ —Ö—É–¥—à—É—é –ø—Ä–æ—Å—Ä–æ—á–∫—É?",
            "–ö–∞–∫–æ–π —Å—Ä–µ–¥–Ω–∏–π MOB –¥–ª—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤?",
            "–°—Ä–∞–≤–Ω–∏ –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–≥–æ—Ä—Ç 2010 –∏ 2014 –≥–æ–¥–æ–≤",
            
            # –ü—Ä–æ–¥—É–∫—Ç—ã
            "–ö–∞–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã–¥–∞—á –ø–æ —Ç–∏–ø–∞–º –ø—Ä–æ–¥—É–∫—Ç–æ–≤?",
            "–ö–∞–∫–æ–π –ø—Ä–æ–¥—É–∫—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ?",
            
            # Cure –∏ Default rates
            "–ö–∞–∫–æ–π cure rate –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥?",
            "–ö–∞–∫–æ–π default rate –ø–æ –∫–æ–≥–æ—Ä—Ç–∞–º?",
            "–°–∫–æ–ª—å–∫–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤–µ—Ä–Ω—É–ª–æ—Å—å –∏–∑ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –≤ current?"
        ]


if __name__ == "__main__":
    # –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –∞–≥–µ–Ω—Ç–∞
    from config import load_config
    
    print("üîß –¢–µ—Å—Ç AI-–∞–≥–µ–Ω—Ç–∞\n")
    
    try:
        # –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        config = load_config()
        print(f"‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ({config.llm_provider})")
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
        agent = CreditSimulationAgent(config)
        print(f"‚úÖ –ê–≥–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω\n")
        
        # –¢–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å
        test_question = "–°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö?"
        print(f"‚ùì –í–æ–ø—Ä–æ—Å: {test_question}\n")
        
        result = agent.query(test_question)
        
        if result["success"]:
            print(f"üí° –û—Ç–≤–µ—Ç:\n{result['answer']}\n")
            print("‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞: {result['error']}")
    
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")

